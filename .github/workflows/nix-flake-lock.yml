name: Update Nix flake.lock
on:
  workflow_dispatch:
  schedule:
    # weekly on Sunday at 2:05am UTC
    # https://crontab.guru/#5_2_*_*_0
    - cron: '5 2 * * 0'

permissions:
  contents: write
  pull-requests: write

jobs:
  lockfile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab
      - name: Install Nix
        # https://github.com/DeterminateSystems/nix-installer-action/releases/tag/v4
        uses: DeterminateSystems/nix-installer-action@65d7c888b2778e8cf30a07a88422ccb23499bfb8
      - name: Update flake.lock
        # https://github.com/DeterminateSystems/update-flake-lock/releases/tag/v19
        uses: DeterminateSystems/update-flake-lock@dec3bc3c9b11c3b9d547f47dfb579b91a6051603
        with:
          commit-msg: "build: update tools/nix/flake.lock"
          git-author-name: '${{ secrets.GPG_USER_NAME }}'
          git-author-email: '${{ secrets.GPG_EMAIL }}'
          git-committer-name: '${{ secrets.GPG_USER_NAME }}'
          git-committer-email: '${{ secrets.GPG_EMAIL }}'
          gpg-passphrase: '${{ secrets.GPG_PASSPHRASE }}'
          gpg-private-key: '${{ secrets.GPG_PRIVATE_KEY }}'
          path-to-flake-dir: 'tools/nix'
          pr-assignees: shanesveller
          pr-reviewers: |
            etorreborre
            shanesveller
          pr-labels: |
            Type: Dependencies
          pr-title: 'chore: Update tools/nix/flake.lock'
          sign-commits: true
          # see also: /.github/PULL_REQUEST_TEMPLATE.md
          pr-body: |
            ## Current behavior

            N/A

            ## Proposed changes

            This is an automated change that has performed the equivalent of
            `nix flake update --commit-lock-file` against `/tools/nix`. An Ockam
            employee familiar with Nix should exercise the local Nix content,
            such as `devShells`, using this branch.

            ## Checks

            - [X] All commits in this Pull Request are [signed](https://docs.github.com/en/authentication/managing-commit-signature-verification/signing-commits) and Verified by Github.
            - [X] All commits in this Pull Request follow the Ockam [commit message convention](https://github.com/build-trust/.github/blob/main/CONTRIBUTING.md#commit-messages).
            - [X] I accept the Ockam Community [Code of Conduct](https://github.com/build-trust/.github/blob/main/CODE_OF_CONDUCT.md).
            - [X] I have accepted the Ockam [Contributor License Agreement](https://github.com/build-trust/ockam-contributors/blob/main/CLA.md) by adding my Git/Github details in a row at the end of the [CONTRIBUTORS.csv](https://github.com/build-trust/ockam-contributors/blob/main/CONTRIBUTORS.csv) file in a separate pull request to the [build-trust/ockam-contributors](https://github.com/build-trust/ockam-contributors) repository. The easiest way to do this is to [edit the CONTRIBUTORS.csv](https://github.com/build-trust/ockam-contributors/edit/main/CONTRIBUTORS.csv) file in the github web UI and create a PR, this will mark the commit as verified.
